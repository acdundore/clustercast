<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Using a Custom Base Regressor - Clustercast</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Using a Custom Base Regressor";
        var mkdocs_page_input_path = "example_custom-regressor.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Clustercast
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Quick Start Examples</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../example_single-series/">Local (Single-Series) Forecasting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../example_multi-series/">Global (Multi-Series) Forecasting</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Using a Custom Base Regressor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../example_exog-features/">Modeling with Exogenous Features</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../example_inspecting-data/">Inspecting Transformed Data</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Clustercast API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../DirectForecaster/">DirectForecaster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../RecursiveForecaster/">RecursiveForecaster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../datasets/">.datasets</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Clustercast</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Quick Start Examples</li>
      <li class="breadcrumb-item active">Using a Custom Base Regressor</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="using-a-custom-base-regressor">Using a Custom Base Regressor</h1>
<p>In this example, we will use a custom base regressor with the direct forecasting class on the airline passengers dataset.
An XGBoost regressor will be used as it natively supports quantile regression.
However, the custom base regressor class could easily be adapted to work with any algorithm that can support quantile regression (i.e. pinball loss).
This could include neural networks (pytorch or tensorflow), linear regression, or a number of other model types.</p>
<hr />
<h2 id="data-preparation">Data Preparation</h2>
<pre><code class="language-python"># imports
from clustercast.datasets import load_airline_passengers
from clustercast import DirectForecaster, RecursiveForecaster

# load airline passenger data 
airline_data = load_airline_passengers()
airline_data['ID'] = 1
print(airline_data)

# only keep data before 1959 for training
airline_data_train = airline_data.loc[
    airline_data['YM'] &lt; dt.datetime(year=1959, month=1, day=1)
]
</code></pre>
<pre><code class="language-profile">            YM  Passengers  ID
0   1949-01-01         112   1
1   1949-02-01         118   1
2   1949-03-01         132   1
3   1949-04-01         129   1
4   1949-05-01         121   1
..         ...         ...  ..
139 1960-08-01         606   1
140 1960-09-01         508   1
141 1960-10-01         461   1
142 1960-11-01         390   1
143 1960-12-01         432   1

[144 rows x 3 columns]
</code></pre>
<pre><code class="language-python"># plot the airline data
fig, ax = plt.subplots(figsize=(10, 4));
sns.lineplot(data=airline_data, x='YM', y='Passengers', ax=ax);
ax.grid(axis='both');
ax.set_title('Airline Passengers', fontsize=16);
</code></pre>
<p><img alt="Airline Data" src="../img/example_single-series_data.png" /></p>
<hr />
<h2 id="create-a-custom-base-regressor">Create a Custom Base Regressor</h2>
<p>In this step, we create a custom regressor class that has the following properties:</p>
<ul>
<li>An "alpha" argument during instantiation that defines the quantile for prediction (defaults at 0.50, equivalent to Mean Absolute Error)</li>
<li>A standard Scikit-Learn compatible fit method</li>
<li>A standard Scikit-Learn compatible predict method</li>
</ul>
<p>This class is essentially a wrapper around <code>XGBRegressor</code> that allows us to pass the quantile regression parameters through the instantiation arguments.
It is apparent that this class could be modified to support essentially any ML algorithm.</p>
<pre><code class="language-python"># creating a wrapper for custom base regressor using XGBoost
class CustomRegressor():
    # provide the quantile as an argument (&quot;alpha&quot;) when instantiating
    def __init__(self, alpha=0.5):
        # create a custom XGBoost regressor using pinball loss with a specified quantile
        self.regressor = XGBRegressor(
            objective='reg:quantileerror', 
            quantile_alpha=alpha, # uses the &quot;alpha&quot; from class instantiation
            n_estimators=300,
            max_depth=8,
            learning_rate=0.05,
            reg_lambda=0.05
        )

    # standard Scikit-Learn fit method
    def fit(self, X, y):
        self.regressor.fit(X, y)
        return self 

    # standard Scikit-Learn predict method
    def predict(self, X, y=None):
        return self.regressor.predict(X)
</code></pre>
<hr />
<h2 id="direct-forecaster">Direct Forecaster</h2>
<p>Now, let's create a direct forecaster with our custom base regressor class.
The parameters of the <code>DirectForecaster</code> are similar to the other examples, with the exception that we pass our
<code>CustomRegressor</code> class to the <code>base_regressor</code> argument when we create the model.</p>
<pre><code class="language-python"># define the model
model = DirectForecaster(
    data=airline_data_train,
    endog_var='Passengers',
    id_var='ID',
    timestep_var='YM',
    group_vars=[],
    exog_vars=[],
    boxcox=0,
    differencing=True,
    lags=12,
    seasonality_ordinal=[12],
    base_regressor=CustomRegressor # pass the CustomRegressor class created earlier
)

# fit the model with a 90% prediction interval
# 24 lookahead models, and automatically calculates CQR calibration set size
model.fit(max_steps=24, alpha=0.10, cqr_cal_size='auto')

# make predictions out to 2 years ahead
direct_preds = model.predict(steps=24)

# display some predictions
print(direct_preds.head())
</code></pre>
<pre><code class="language-profile">   ID         YM    Forecast  Forecast_0.050  Forecast_0.950
0   1 1959-01-01  344.578409      282.426612      355.635304
1   1 1959-02-01  319.566975      251.435909      438.184587
2   1 1959-03-01  378.031777      275.022579      442.401312
3   1 1959-04-01  370.820691      270.167072      448.559809
4   1 1959-05-01  373.634456      289.659967      476.273913
</code></pre>
<pre><code class="language-python"># display the predictions, including the prediction intervals
fig, ax = plt.subplots(figsize=(10, 4));
sns.lineplot(data=airline_data, x='YM', y='Passengers', ax=ax);
sns.lineplot(data=direct_preds, x='YM', y='Forecast', ax=ax);
ax.grid(axis='both');
ax.set_title('Airline Passengers: Direct Forecast', fontsize=16);
ax.fill_between(x=direct_preds['YM'], y1=direct_preds.iloc[:, -2], y2=direct_preds.iloc[:, -1], alpha=0.2, color='orange');
</code></pre>
<p><img alt="Direct Forecast" src="../img/example_custom-regressor_direct.png" /></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../example_multi-series/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../example_exog-features/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
